---
# Configuración del documento
title: "Despacho de Energía Eléctrica"
subtitle: "Análisis Despacho de Energía Eléctrica en Colombia"
# date: "`r Sys.Date()`"
# author: "Abraham García"
output:
  html_document: 
    fig_height: 7
    fig_width: 10
    highlight: tango
    keep_md: no #yes
    number_sections: no
    theme: paper #cerulean
    toc: yes
    toc_depth: 4
    toc_float:
      collapsed: yes #no
      smooth_scroll: yes
  #runtime: shiny
  pdf_document:
    toc: yes
    toc_depth: '4'
  word_document:
    toc: yes
    toc_depth: '4'
editor_options:
  
  chunk_output_type: console
---

Este informe analiza el comportamiento del despacho de energía eléctrica en Colombia durante los últimos siete años, abarcando el período comprendido entre abril de 2018 y abril de 2025.
A continuación, se presenta un análisis descriptivo de las siguientes variables:

- Demanda [GWh/día]
- Aportes Hidrológicos [GWh/día]
- Embalses [GWh]
- Despacho de energía eléctrica [GWh/día]
- Precio de bolsa [COP/kWh]

```{r include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE
)

#⚡Recuerde instalar las librerias si no lo ha hecho antes.
# con install.packages
#install.packages("tidyverse")

library(openxlsx)
library(tidyverse)
library(janitor)
library(flextable)
library(kableExtra)
library(scales)
library(ggplot2)
library(plotly)
library(dplyr)
library(forcats)

# Lectura de los dataset
df_variables_despacho <- read.xlsx("data/despacho_energia_colombia.xlsx",sheet = "VariablesDespacho")

df_despacho_energia <- read.xlsx("data/despacho_energia_colombia.xlsx",sheet = "DespachoEnergia")

```

```{r}
# Parametros de configuración

colores_personalizados <- c(
  "SOL" = "#FFD700",
  "MENORES" = "#696969",
  "LIQUIDOS" = "#e31a1c",
  "GAS" = "#32CD32",
  "CARBON" = "#FF8C00",
  "AGUA" = "#00CED1"
)
```


```{r}

# Filtrar ambos conjuntos para que solo queden las fechas que son comunes a ambos dataset
fechas_comunes <- intersect(df_variables_despacho$fecha, df_despacho_energia$fecha)

df_variables_despacho <- df_variables_despacho[df_variables_despacho$fecha %in% fechas_comunes,]
df_despacho_energia <- df_despacho_energia[df_despacho_energia$fecha %in% fechas_comunes,]

# Formatear las columnas de fechas

df_variables_despacho <- df_variables_despacho %>% 
  mutate(fecha = as.Date(df_variables_despacho$fecha, origin = "1899-12-30"))

df_despacho_energia <- df_despacho_energia %>% 
  mutate(fecha = as.Date(df_despacho_energia$fecha, origin = "1899-12-30"),
         anio = as.numeric(format(fecha, "%Y")),
         mes = as.numeric(format(fecha,"%m")),
         dia = as.numeric(format(fecha, "%d")))

```


```{r}
# 2. Preparar los datos
df_plot <- df_despacho_energia %>%
  filter(anio == 2024) %>%
  mutate(combustiblePrimario = fct_relevel(
    combustiblePrimario,
    "SOL", "MENORES", "LIQUIDOS", "GAS", "CARBON", "AGUA"
  ))

# 3. Construir el gráfico en el orden correcto (de abajo hacia arriba)
orden_correcto <- rev(names(colores_personalizados))  # <- Invertir el orden para apilado correcto

g1_plotly <- plot_ly()

for (combustible in orden_correcto) {
  df_temp <- df_plot %>% filter(combustiblePrimario == combustible)
  
  g1_plotly <- g1_plotly %>%
    add_trace(
      data = df_temp,
      x = ~fecha,
      y = ~despachoDiario,
      type = 'scatter',
      mode = 'none',
      stackgroup = 'one',
      fillcolor = colores_personalizados[[combustible]],
      name = combustible
    )
}

# 4. Personalizar layout
g1_plotly <- g1_plotly %>%
  layout(
    xaxis = list(
      rangeselector = list(
        buttons = list(
          list(count = 3, label = "3M", step = "month", stepmode = "backward"),
          list(count = 6, label = "6M", step = "month", stepmode = "backward"),
          list(count = 9, label = "9M", step = "month", stepmode = "backward"),
          list(step = "all", label = "Todo")
        )
      ),
      rangeslider = list(visible = TRUE),
      title = "Fecha"
    ),
    yaxis = list(title = "Despacho Diario (MW)"),
    hovermode = "x unified"  # Opcional: para que todos los datos salgan alineados en el hover
  )

# 5. Mostrar gráfico
g1_plotly


```



# Gráfica Animada e interactiva
```{r}

df_aportes <- df_variables_despacho %>%
  mutate(variableEnergia="aportesPorcentaje", valor = aportesPorcentaje) %>% 
  select(fecha, anio, mes, dia, festivo, diaSemana,variableEnergia, valor)

df_embalse <- df_variables_despacho %>%
  mutate(variableEnergia="embalsePorcentaje", valor = embalsePorcentaje) %>% 
  select(fecha, anio, mes, dia, festivo, diaSemana,variableEnergia, valor)

df_hidrologia <- bind_rows(df_aportes, df_embalse)

# Función accumulate_by corregida
accumulate_by <- function(dat, var) {
  var_expr <- rlang::enquo(var)
  var_sym <- rlang::get_expr(var_expr)
  
  if (rlang::is_formula(var_sym)) {
    var_sym <- rlang::f_rhs(var_sym)
  }
  
  var_name <- rlang::as_name(var_sym)
  
  lvls <- sort(unique(dat[[var_name]]))
  dats <- lapply(seq_along(lvls), function(x) {
    cbind(dat[dat[[var_name]] %in% lvls[seq_len(x)], ], frame = lvls[[x]])
  })
  dplyr::bind_rows(dats)
}

# Construcción
fig_raw <- df_hidrologia %>%
  filter(anio == 2024, variableEnergia %in% c("aportesPorcentaje", "embalsePorcentaje")) %>%
  accumulate_by(~fecha)

# Obtener límites del eje x e y
x_min <- min(fig_raw$fecha, na.rm = TRUE)
x_max <- max(fig_raw$fecha, na.rm = TRUE)
y_min <- min(fig_raw$valor, na.rm = TRUE)
y_max <- max(fig_raw$valor, na.rm = TRUE)

# Ahora fija esos límites en layout
fig <- fig_raw %>%
  plot_ly(
    x = ~fecha,
    y = ~valor,
    split = ~variableEnergia,
    frame = ~frame,
    type = 'scatter',
    mode = 'lines',
    line = list(simplify = FALSE)
  ) %>%
  layout(
    xaxis = list(title = "Fecha", zeroline = FALSE, range = c(x_min, x_max)),
    yaxis = list(title = "Porcentaje", zeroline = FALSE, range = c(y_min, y_max)),
    tickformat = "%b %Y", # Formato bonito: abreviatura del mes y año
    rangeslider = list(visible = TRUE)
  ) %>%
  animation_opts(
    frame = 0,
    transition = 0,
    redraw = FALSE
  ) %>%
  animation_slider(
  hide = FALSE
  ) %>% 
  animation_button(
    x = 1, xanchor = "right", y = 0, yanchor = "bottom"
  )

fig
```

